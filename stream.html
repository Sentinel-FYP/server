<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <img id="image" />
    <button id="start-btn">start stream</button>
    <button id="stop-btn">stop stream</button>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.4/socket.io.js"></script>
    <script>
      const online_server = "http://13.51.86.179:5500";
      const local_server = "http://localhost:5500";
      const socket = io.connect(local_server);
      const buffer = [];
      socket.on("connect", () => {
        console.log("connected");
        socket.emit("join room", { deviceId: "abc" });
        socket.emit("cameras:add", {
          deviceId: "abc",
          cameraIP: "192.168.1.7:8554",
          username: "admin",
          password: "admin"
        })
      });

      socket.on("disconnect", () => {
          console.log("disconnected");
        });
      
      socket.on("stream:send", ({ frame }) => {
        let base64 = btoa(
          new Uint8Array(frame).reduce((data, byte) => data + String.fromCharCode(byte), "")
        );
        base64 = atob(base64);
        buffer.push(base64);
        // console.log("Stream", buffer);
      });

      let interval = undefined;

      document.getElementById("start-btn").addEventListener("click", () => {
        socket.emit("stream:start", { deviceId: "abc", cameraIP: "192.168.1.7:8554" });
        interval = setInterval(() => {
          //console.log(buffer.length);
          if (buffer.length > 60) {
            console.log('buffer length is now greater')
            let frame = buffer.shift();
            //console.log("Frame", frame);
            document.getElementById("image").src = "data:image/jpeg;base64," + frame;
          }
          else {
            console.log('buffer length is less ')
          }
        }, 1000 / 60);
      });

      document.getElementById("stop-btn").addEventListener("click", () => {
        socket.emit("stream:end", { deviceId: "abc", cameraIP: "192.168.1.7:8554" });
        console.log(interval)
        if(typeof interval !== 'undefined'){
          console.log('clearing interval');
          clearInterval(interval);
        }
          
    

        
      });

      
      
    </script>
  </body>
</html>
